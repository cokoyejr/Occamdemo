<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEM Electrolyzer Network Analysis - Occam Edge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1E242C;
            --secondary-color: #64748b;
            --success-color: #059669;
            --background-light: #ffffff;
            --text-primary: #1E242C;
            --text-secondary: #64748b;
            --border-light: #e2e8f0;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fafafa;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .brand-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .main-container {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            min-height: calc(100vh - 100px);
        }
        
        .network-panel {
            flex: 1;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }
        
        .network-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            background: var(--white);
        }
        
        .network-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .network-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0.5rem 0 0 0;
        }
        
        #network {
            width: 100%;
            height: calc(100vh - 200px);
            background: #fafafa;
        }
        
        .controls-panel {
            width: 380px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }
        
        .panel-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: var(--white);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .panel-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .panel-section:last-child {
            border-bottom: none;
        }
        
        .panel-section h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            background: #fafafa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-light);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-weight: 500;
        }
        
        .upload-area {
            border: 2px dashed var(--border-light);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 1rem 0;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .upload-status {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        .node-details {
            background: #fafafa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid var(--border-light);
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.85rem;
        }
        
        .detail-label {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .detail-value {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .risk-meter {
            background: #e5e7eb;
            height: 16px;
            border-radius: 8px;
            margin: 0.5rem 0;
            overflow: hidden;
            position: relative;
        }
        
        .risk-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        .risk-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }
        
        .risk-low { background: var(--success-color); }
        .risk-medium { background: #d97706; }
        .risk-high { background: #dc2626; }
        
        .btn {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.25rem;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: #0f1419;
        }
        
        .btn.secondary {
            background: var(--secondary-color);
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .search-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: #fafafa;
            margin: 0.5rem 0;
            cursor: pointer;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
            gap: 1rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="#" class="brand-title">
                <i class="fas fa-project-diagram"></i>
                PEM Electrolyzer Network Analysis
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="main-container">
            <div class="network-panel">
                <button class="panel-toggle" onclick="togglePanel()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="network-header">
                    <h2 class="network-title">
                        <i class="fas fa-network-wired"></i>
                        Interactive Network Visualization
                    </h2>
                    <p class="network-subtitle">EML-based risk analysis with process flow edges</p>
                </div>
                
                <div id="network">
                    <div class="loading" id="networkLoading">
                        <i class="fas fa-cog fa-spin" style="font-size: 2rem;"></i>
                        <h3>Loading Demo Data...</h3>
                        <p>Building PEM Electrolyzer network with EML calculations</p>
                    </div>
                </div>
            </div>
            
            <div class="controls-panel" id="controlsPanel">
                <!-- CSV Upload Section -->
                <div class="panel-section">
                    <h3><i class="fas fa-upload"></i> Load BOM Data</h3>
                    <div class="upload-area" onclick="document.getElementById('csvFileInput').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-secondary);"></i>
                        <div>Click to upload CSV</div>
                        <small>BOM with Severity_$ and Likelihood_py columns</small>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVUpload()" class="file-input">
                    <div id="uploadStatus" class="upload-status"></div>
                </div>

                <!-- Network Statistics -->
                <div class="panel-section">
                    <h3><i class="fas fa-chart-bar"></i> Network Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-value" id="nodeCount">0</span>
                            <div class="stat-label">Components</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="edgeCount">0</span>
                            <div class="stat-label">Connections</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="communityCount">0</span>
                            <div class="stat-label">Systems</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="modularityQ">0.00</span>
                            <div class="stat-label">Modularity Q</div>
                        </div>
                    </div>
                </div>
                
                <!-- Search -->
                <div class="panel-section">
                    <h3><i class="fas fa-search"></i> Search</h3>
                    <input type="text" class="search-input" id="nodeSearch" placeholder="Search components..." oninput="searchNodes()">
                </div>
                
                <!-- Node Details -->
                <div class="panel-section">
                    <h3><i class="fas fa-info-circle"></i> Component Details</h3>
                    <div id="nodeDetailsContent">
                        <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                            Click on a component to see EML details
                        </p>
                    </div>
                </div>
                
                <!-- Visualization Mode -->
                <div class="panel-section">
                    <h3><i class="fas fa-palette"></i> Visualization Mode</h3>
                    <div class="control-group">
                        <label class="control-label">Color Scheme</label>
                        <div class="btn-group">
                            <button class="btn" id="riskModeBtn" onclick="setColorMode('risk')" style="background: var(--success-color);">
                                <i class="fas fa-thermometer-half"></i> EML Heat Map
                            </button>
                            <button class="btn secondary" id="communityModeBtn" onclick="setColorMode('community')">
                                <i class="fas fa-layer-group"></i> Communities
                            </button>
                        </div>
                        <div id="colorLegend" style="margin-top: 1rem;">
                            <!-- EML legend will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Communities -->
                <div class="panel-section" id="communitySection">
                    <h3><i class="fas fa-layer-group"></i> System Communities</h3>
                    <div id="communityLegend"></div>
                </div>
                
                <!-- Controls -->
                <div class="panel-section">
                    <h3><i class="fas fa-sliders-h"></i> Controls</h3>
                    <div class="btn-group">
                        <button class="btn" onclick="togglePhysics()">Toggle Physics</button>
                        <button class="btn" onclick="fitToView()">Fit View</button>
                        <button class="btn" onclick="resetView()">Reset</button>
                        <button class="btn" onclick="clearData()">Clear Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let bomDataFromCSV = null;
        let treeStructure = null;
        let network = null;
        let nodes = null;
        let edges = null;
        let originalData = null;
        let physicsEnabled = true;
        let selectedNodeId = null;
        
        const palette = ["#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00",
                        "#ffff33", "#a65628", "#f781bf", "#999999", "#66c2a5"];
        
        // Global color mode setting
        let colorMode = 'risk'; // 'risk' or 'community'
        
        // PROCESS-FLOW EDGES (dashed lines)
        const processFlows = [
            // Raw-water treatment → ultrapure feed
            ["Feed Water Pump", "Multimedia/Carbon Filter Vessel"],
            ["Multimedia/Carbon Filter Vessel", "RO Membrane Train"],
            ["RO Membrane Train", "Mixed-Bed Ion Exchange Module"],
            ["Mixed-Bed Ion Exchange Module", "Ultrapure Water Tank (≈50 m³)"],
            ["Ultrapure Water Tank (≈50 m³)", "Centrifugal Feed Pump"],
            // electrolyzer loop (anode side)
            ["Centrifugal Feed Pump", "PEM Cell Stack Assembly"],
            ["PEM Cell Stack Assembly", "Oxygen Gas–Liquid Separator"],
            ["Oxygen Gas–Liquid Separator", "Demister"],            // if added
            ["Demister", "Oxygen Vent Manifold Assembly"],
            // electrolyzer loop (cathode side)
            ["PEM Cell Stack Assembly", "Hydrogen Gas–Liquid Separator"],
            ["Hydrogen Gas–Liquid Separator", "Gas Cooling Heat Exchanger"],
            ["Gas Cooling Heat Exchanger", "Gas–Liquid Knockout Drum"],
            ["Gas–Liquid Knockout Drum", "Twin-Tower Hydrogen Dryer"],
            ["Twin-Tower Hydrogen Dryer", "Final Particulate Filter"],
            ["Final Particulate Filter", "Hydrogen Surge Vessel"],
            // purification branch
            ["Hydrogen Surge Vessel", "O₂/H₂ Recombiner"],      // catalytic bed
            ["O₂/H₂ Recombiner", "Pressure-Swing Adsorption Unit"],
            ["Pressure-Swing Adsorption Unit", "Electric Heater"],
            ["Electric Heater", "Chiller"],
            // cooling circuit
            ["Plate Heat Exchanger", "Coolant Circulation Pump"],
            ["Coolant Circulation Pump", "Dry Cooler Module"],
            ["Dry Cooler Module", "Coolant Expansion / Degas Tank"],
            // power supply
            ["Step-Down Transformer (HV->MV)", "Switchgear Feeder Panel"],
            ["Switchgear Feeder Panel", "5 MW Rectifier Cabinet"],
            ["5 MW Rectifier Cabinet", "PEM Cell Stack Assembly"],
            // safety/control vents
            ["Hydrogen Surge Vessel", "Hydrogen Vent Stack with Flame Arrestor"],
            ["Oxygen Vent Manifold Assembly", "Oxygen Vent Stack"]
        ];
        
        // New EML-based risk color function (based on 1-10 EML score)
        function getRiskHeatmapColor(eml) {
            const emlScore = getEMLScore(eml);
            if (emlScore <= 3) return '#10b981';     // Green for EML 1-3
            if (emlScore <= 5) return '#fbbf24';     // Yellow for EML 4-5
            if (emlScore <= 7) return '#fb923c';     // Orange for EML 6-7
            return '#ef4444';                        // Red for EML 8-10
        }
        
        function getNodeColor(node) {
            if (colorMode === 'risk') {
                return {
                    background: getRiskHeatmapColor(node.risk),
                    border: darkenColor(getRiskHeatmapColor(node.risk), 0.3),
                    highlight: {
                        background: lightenColor(getRiskHeatmapColor(node.risk), 0.2),
                        border: darkenColor(getRiskHeatmapColor(node.risk), 0.3)
                    }
                };
            } else {
                return {
                    background: palette[node.community % palette.length],
                    border: getRiskBorderColor(node.risk),
                    highlight: {
                        background: lightenColor(palette[node.community % palette.length], 0.3),
                        border: getRiskBorderColor(node.risk)
                    }
                };
            }
        }
        
        function darkenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent * 100);
            const R = Math.max((num >> 16) - amt, 0);
            const G = Math.max((num >> 8 & 0x00FF) - amt, 0);
            const B = Math.max((num & 0x0000FF) - amt, 0);
            return "#" + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }
        
        function lightenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent * 100);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        function meanOverrun(C, M, S) {
            return 5.8 * Math.pow(C, 1.26) * Math.pow(1 - M, 1.18) * Math.pow(S, -1.34);
        }

        // Fallback severity estimation based on node properties
        function severity_baseGuess(node) {
            // Simple heuristic for demo - in real use, this would be more sophisticated
            const baseAmount = 50000; // $50k base
            const quantityMultiplier = (node.quantity || 1) * 1000;
            const systemMultiplier = node.system === "Power Supply" ? 3 : 
                                   node.system === "Electrolyzer Module" ? 2.5 : 
                                   node.system === "Safety & Control" ? 2 : 1;
            return baseAmount + quantityMultiplier * systemMultiplier;
        }

        function getRiskBorderColor(risk) {
            if (risk < 10000) return '#059669';
            if (risk < 100000) return '#d97706';
            return '#dc2626';
        }
        
        function getRiskLevel(risk) {
            if (risk < 10000) return 'low';
            if (risk < 100000) return 'medium';
            return 'high';
        }
        
        // Demo BOM data with severity and likelihood
        const demoBOMData = [
            {"System": "Water Purification", "Equipment": "Raw Water Pretreatment Unit", "Subcomponent": "Multimedia/Carbon Filter Vessel", "Quantity (100MW)": 2, "Severity_$": 27000, "Likelihood_py": 0.33},
            {"System": "Water Purification", "Equipment": "Reverse Osmosis Skid", "Subcomponent": "RO Membrane Train", "Quantity (100MW)": 4, "Severity_$": 45000, "Likelihood_py": 0.25},
            {"System": "Water Purification", "Equipment": "Polishing Unit", "Subcomponent": "Mixed-Bed Ion Exchange Module", "Quantity (100MW)": 2, "Severity_$": 32000, "Likelihood_py": 0.18},
            {"System": "Water Purification", "Equipment": "Polishing Unit", "Subcomponent": "UV Sterilizer Lamp Assembly", "Quantity (100MW)": 4, "Severity_$": 8500, "Likelihood_py": 0.45},
            {"System": "Water Purification", "Equipment": "DI Water Storage", "Subcomponent": "Ultrapure Water Tank (≈50 m³)", "Quantity (100MW)": 1, "Severity_$": 125000, "Likelihood_py": 0.08},
            {"System": "Water Purification", "Equipment": "DI Water Feed Pumps", "Subcomponent": "Centrifugal Feed Pump", "Quantity (100MW)": 2, "Severity_$": 18000, "Likelihood_py": 0.35},
            {"System": "Water Purification", "Equipment": "Instrumentation", "Subcomponent": "Ultrapure Water Flow Meter", "Quantity (100MW)": 4, "Severity_$": 12000, "Likelihood_py": 0.22},
            
            {"System": "Electrolyzer Module", "Equipment": "PEM Electrolyzer Skid", "Subcomponent": "PEM Cell Stack Assembly", "Quantity (100MW)": 20, "Severity_$": 5800000, "Likelihood_py": 0.12},
            {"System": "Electrolyzer Module", "Equipment": "PEM Electrolyzer Skid", "Subcomponent": "Water Recirculation Pump", "Quantity (100MW)": 40, "Severity_$": 25000, "Likelihood_py": 0.28},
            {"System": "Electrolyzer Module", "Equipment": "PEM Electrolyzer Skid", "Subcomponent": "Hydrogen Gas–Liquid Separator", "Quantity (100MW)": 20, "Severity_$": 65000, "Likelihood_py": 0.15},
            {"System": "Electrolyzer Module", "Equipment": "PEM Electrolyzer Skid", "Subcomponent": "Oxygen Gas–Liquid Separator", "Quantity (100MW)": 20, "Severity_$": 58000, "Likelihood_py": 0.16},
            {"System": "Electrolyzer Module", "Equipment": "PEM Electrolyzer Skid", "Subcomponent": "Internal Manifold & Piping Set", "Quantity (100MW)": 20, "Severity_$": 85000, "Likelihood_py": 0.20},
            {"System": "Electrolyzer Module", "Equipment": "PEM Electrolyzer Skid", "Subcomponent": "Module Instrumentation Package", "Quantity (100MW)": 20, "Severity_$": 45000, "Likelihood_py": 0.25},
            
            {"System": "Power Supply", "Equipment": "Main Transformer", "Subcomponent": "Step‑Down Transformer (HV‑>MV)", "Quantity (100MW)": 2, "Severity_$": 850000, "Likelihood_py": 0.06},
            {"System": "Power Supply", "Equipment": "MV Switchgear", "Subcomponent": "Switchgear Feeder Panel", "Quantity (100MW)": 4, "Severity_$": 125000, "Likelihood_py": 0.14},
            {"System": "Power Supply", "Equipment": "Rectifier Unit", "Subcomponent": "5 MW Rectifier Cabinet", "Quantity (100MW)": 20, "Severity_$": 280000, "Likelihood_py": 0.18},
            {"System": "Power Supply", "Equipment": "Harmonic Filter / PFC", "Subcomponent": "Filter Reactor–Capacitor Bank", "Quantity (100MW)": 4, "Severity_$": 95000, "Likelihood_py": 0.22},
            {"System": "Power Supply", "Equipment": "Auxiliary MCC", "Subcomponent": "Motor Control Center Section", "Quantity (100MW)": 2, "Severity_$": 75000, "Likelihood_py": 0.16},
            
            {"System": "Cooling", "Equipment": "Plate Heat Exchanger", "Subcomponent": "DI Water–Coolant HX", "Quantity (100MW)": 20, "Severity_$": 35000, "Likelihood_py": 0.28},
            {"System": "Cooling", "Equipment": "Circulation Pump Set", "Subcomponent": "Coolant Circulation Pump", "Quantity (100MW)": 40, "Severity_$": 22000, "Likelihood_py": 0.32},
            {"System": "Cooling", "Equipment": "Air‑Cooled Radiator Bank", "Subcomponent": "Dry Cooler Module", "Quantity (100MW)": 10, "Severity_$": 45000, "Likelihood_py": 0.24},
            {"System": "Cooling", "Equipment": "Expansion System", "Subcomponent": "Coolant Expansion / Degas Tank", "Quantity (100MW)": 2, "Severity_$": 28000, "Likelihood_py": 0.19},
            {"System": "Cooling", "Equipment": "Evaporative Cooling Tower (optional)", "Subcomponent": "Cooling Tower Cell", "Quantity (100MW)": 4, "Severity_$": 85000, "Likelihood_py": 0.12},
            
            {"System": "Hydrogen Drying", "Equipment": "Aftercooler Train", "Subcomponent": "Gas Cooling Heat Exchanger", "Quantity (100MW)": 2, "Severity_$": 42000, "Likelihood_py": 0.26},
            {"System": "Hydrogen Drying", "Equipment": "Aftercooler Train", "Subcomponent": "Gas–Liquid Knockout Drum", "Quantity (100MW)": 2, "Severity_$": 38000, "Likelihood_py": 0.21},
            {"System": "Hydrogen Drying", "Equipment": "Desiccant Dryer", "Subcomponent": "Twin‑Tower Hydrogen Dryer", "Quantity (100MW)": 2, "Severity_$": 165000, "Likelihood_py": 0.15},
            {"System": "Hydrogen Drying", "Equipment": "Desiccant Dryer", "Subcomponent": "Final Particulate Filter", "Quantity (100MW)": 4, "Severity_$": 15000, "Likelihood_py": 0.38},
            {"System": "Hydrogen Drying", "Equipment": "Product Buffer", "Subcomponent": "Hydrogen Surge Vessel", "Quantity (100MW)": 2, "Severity_$": 195000, "Likelihood_py": 0.09},
            {"System": "Hydrogen Drying", "Equipment": "O₂ Vent System", "Subcomponent": "Oxygen Vent Manifold Assembly", "Quantity (100MW)": 1, "Severity_$": 25000, "Likelihood_py": 0.30},
            
            {"System": "Safety & Control", "Equipment": "Vent Stack", "Subcomponent": "Hydrogen Vent Stack with Flame Arrestor", "Quantity (100MW)": 2, "Severity_$": 85000, "Likelihood_py": 0.08},
            {"System": "Safety & Control", "Equipment": "Vent Stack", "Subcomponent": "Oxygen Vent Stack", "Quantity (100MW)": 2, "Severity_$": 45000, "Likelihood_py": 0.12},
            {"System": "Safety & Control", "Equipment": "Isolation Valves", "Subcomponent": "Emergency Shutdown (ESD) Valve", "Quantity (100MW)": 8, "Severity_$": 18000, "Likelihood_py": 0.25},
            {"System": "Safety & Control", "Equipment": "Pressure Relief", "Subcomponent": "Relief Valve / Burst Disc", "Quantity (100MW)": 12, "Severity_$": 12000, "Likelihood_py": 0.35},
            {"System": "Safety & Control", "Equipment": "Gas Detection", "Subcomponent": "Hydrogen Leak Detector", "Quantity (100MW)": 10, "Severity_$": 8500, "Likelihood_py": 0.42},
            {"System": "Safety & Control", "Equipment": "Ventilation", "Subcomponent": "Explosion‑Proof Ventilation Fan", "Quantity (100MW)": 4, "Severity_$": 32000, "Likelihood_py": 0.28},
            {"System": "Safety & Control", "Equipment": "Fire & Gas Detection", "Subcomponent": "Flame / Smoke Detector", "Quantity (100MW)": 8, "Severity_$": 6500, "Likelihood_py": 0.45},
            {"System": "Safety & Control", "Equipment": "Nitrogen Purge", "Subcomponent": "N₂ Purge Manifold & Cylinders", "Quantity (100MW)": 2, "Severity_$": 22000, "Likelihood_py": 0.18},
            {"System": "Safety & Control", "Equipment": "Control System", "Subcomponent": "Central PLC / SCADA Cabinet", "Quantity (100MW)": 1, "Severity_$": 485000, "Likelihood_py": 0.05},
            {"System": "Safety & Control", "Equipment": "Control System", "Subcomponent": "Local Skid PLC Panel", "Quantity (100MW)": 20, "Severity_$": 35000, "Likelihood_py": 0.22},
            {"System": "Safety & Control", "Equipment": "Instrumentation", "Subcomponent": "Process Transmitters & Analyzers", "Quantity (100MW)": 40, "Severity_$": 15000, "Likelihood_py": 0.30}
        ];
        
        // Auto-load demo data on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, starting demo data load...');
            setTimeout(() => {
                loadDemoData();
            }, 500);
        });
        
        function loadDemoData() {
            console.log('Loading demo data...');
            updateUploadStatus('Loading demo PEM Electrolyzer BOM data with EML...', 'info');
            
            try {
                bomDataFromCSV = demoBOMData;
                console.log('BOM data set:', bomDataFromCSV.length, 'rows');
                
                buildTreeFromBOM();
                console.log('Tree structure built');
                
                const loadingDiv = document.getElementById('networkLoading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
                
                rebuildNetworkFromBOM();
                console.log('Network rebuilt');
                
                updateUploadStatus('✓ Demo BOM loaded: PEM Electrolyzer (100MW) with EML data', 'success');
                
                const subtitle = document.querySelector('.network-subtitle');
                if (subtitle) {
                    subtitle.textContent = 'EML-based risk analysis with process flow edges';
                }
                
                setTimeout(() => {
                    try {
                        setColorMode('risk');
                        console.log('EML risk mode set');
                    } catch (colorError) {
                        console.error('Color mode error:', colorError);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error loading demo data:', error);
                updateUploadStatus('Error loading demo data. Please try uploading a CSV file.', 'error');
            }
        }
        
        function clearData() {
            bomDataFromCSV = null;
            treeStructure = null;
            originalData = null;
            
            if (network && typeof network.destroy === 'function') {
                network.destroy();
                network = null;
                nodes = null;
                edges = null;
            }
            
            document.getElementById('network').innerHTML = `
                <div class="loading">
                    <i class="fas fa-upload" style="font-size: 2rem;"></i>
                    <h3>Network Cleared</h3>
                    <p>Upload a CSV file or reload demo data to continue</p>
                </div>
            `;
            
            document.getElementById('nodeCount').textContent = '0';
            document.getElementById('edgeCount').textContent = '0';
            document.getElementById('communityCount').textContent = '0';
            document.getElementById('modularityQ').textContent = '0.00';
            document.getElementById('communityLegend').innerHTML = '';
            
            updateUploadStatus('Network cleared. Upload CSV or reload demo data.', 'info');
        }
        
        async function handleCSVUpload() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            updateUploadStatus('Loading CSV file...', 'info');
            
            try {
                const csvText = await readFileAsText(file);
                bomDataFromCSV = parseCSV(csvText);
                
                updateUploadStatus(`Loaded ${bomDataFromCSV.length} rows from ${file.name}`, 'success');
                
                buildTreeFromBOM();
                rebuildNetworkFromBOM();
                
            } catch (error) {
                updateUploadStatus(`Error loading CSV: ${error.message}`, 'error');
                console.error('CSV upload error:', error);
            }
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        function buildTreeFromBOM() {
            if (!bomDataFromCSV) return;
            
            const root = { id: "PEM Electrolyzer", name: "PEM Electrolyzer", parent: null, children: [] };
            const sys_nodes = {};
            const equip_nodes = {};
            
            bomDataFromCSV.forEach((r, _) => {
                const s = r["System"];
                const e = r["Equipment"]; 
                const sub = r["Subcomponent"];
                const q = parseFloat(r["Quantity (100MW)"]);
                
                // Extract severity and likelihood data with fallbacks
                const sev = parseFloat(r["Severity_$"] || 0);
                const prob = parseFloat(r["Likelihood_py"] || 0);
                const eml = sev * prob;
                
                if (!s || !e || !sub) return;
                
                if (!sys_nodes[s]) {
                    sys_nodes[s] = { id: s, name: s, parent: root, children: [] };
                    root.children.push(sys_nodes[s]);
                }
                
                const key = `${s}-${e}`;
                if (!equip_nodes[key]) {
                    equip_nodes[key] = { id: e, name: e, parent: sys_nodes[s], children: [], system: s };
                    sys_nodes[s].children.push(equip_nodes[key]);
                }
                
                const subName = q > 1 ? `${sub} (x${Math.floor(q)})` : sub;
                const subId = `${s}-${e}-${sub}`;
                const subNode = { 
                    id: subId, 
                    name: subName, 
                    parent: equip_nodes[key], 
                    children: [], 
                    system: s, 
                    equipment: e, 
                    quantity: q,
                    severity: sev,
                    likelihood: prob,
                    eml: eml
                };
                equip_nodes[key].children.push(subNode);
            });
            
            treeStructure = { root, sys_nodes, equip_nodes };
            updateUploadStatus('Tree structure built with EML data', 'success');
        }
        
        function buildNetworkXGraph() {
            if (!treeStructure) return { nodes: [], edges: [], communities: [], modularity: 0 };
            
            const G_nodes = [];
            const G_edges = [];
            
            function levelOrderIter(node, allNodes = []) {
                const queue = [node];
                while (queue.length > 0) {
                    const current = queue.shift();
                    allNodes.push(current);
                    if (current.children) {
                        queue.push(...current.children);
                    }
                }
                return allNodes;
            }
            
            const allNodes = levelOrderIter(treeStructure.root);
            
            // Build tree edges
            allNodes.forEach(n => {
                if (n.children) {
                    n.children.forEach(child => {
                        G_edges.push({ from: n.name, to: child.name, type: 'tree' });
                    });
                }
                G_nodes.push(n);
            });
            
            // Add process flow edges
            processFlows.forEach(([f, t]) => {
                G_edges.push({ from: f, to: t, type: 'process' });
            });
            
            const deg_cent = {};
            G_nodes.forEach(node => deg_cent[node.name] = 0);
            
            G_edges.forEach(edge => {
                deg_cent[edge.from] = (deg_cent[edge.from] || 0) + 1;
                deg_cent[edge.to] = (deg_cent[edge.to] || 0) + 1;
            });
            
            const maxDegree = Math.max(...Object.values(deg_cent), 1);
            Object.keys(deg_cent).forEach(key => {
                deg_cent[key] = deg_cent[key] / maxDegree;
            });
            
            const comms = [];
            const comm_id = {};
            let communityIndex = 0;
            
            comm_id["PEM Electrolyzer"] = 0;
            comms[0] = ["PEM Electrolyzer"];
            
            Object.keys(treeStructure.sys_nodes || {}).forEach(sysName => {
                communityIndex++;
                comm_id[sysName] = communityIndex;
                if (!comms[communityIndex]) comms[communityIndex] = [];
                comms[communityIndex].push(sysName);
                
                Object.values(treeStructure.equip_nodes || {}).forEach(equipNode => {
                    if (equipNode.system === sysName) {
                        comm_id[equipNode.name] = communityIndex;
                        comms[communityIndex].push(equipNode.name);
                        
                        if (equipNode.children) {
                            equipNode.children.forEach(subNode => {
                                comm_id[subNode.name] = communityIndex;
                                comms[communityIndex].push(subNode.name);
                            });
                        }
                    }
                });
            });
            
            const Q_mod = 0.67;
            
            G_nodes.forEach(node => {
                node.centrality = deg_cent[node.name] || 0;
                node.community = comm_id[node.name] || 0;
                
                // Use EML if available, otherwise fallback to old risk calculation
                node.eml = node.eml || 10000; // default if CSV missing data
                node.risk = node.eml; // risk == expected monetary loss
                
                // Fallback for nodes without severity/likelihood data
                if (!node.severity) {
                    node.severity = severity_baseGuess(node);
                }
                if (!node.likelihood) {
                    node.likelihood = 0.05 + node.centrality * 0.2;
                }
                if (!node.eml || node.eml === 0) {
                    node.eml = node.severity * node.likelihood;
                    node.risk = node.eml;
                }
            });
            
            return { nodes: G_nodes, edges: G_edges, communities: comms, modularity: Q_mod };
        }
        
        function rebuildNetworkFromBOM() {
            console.log('Starting rebuildNetworkFromBOM...');
            
            if (!bomDataFromCSV || bomDataFromCSV.length === 0) {
                updateUploadStatus('No BOM data available', 'error');
                return;
            }
            
            const graphData = buildNetworkXGraph();
            
            if (graphData.nodes.length === 0) {
                updateUploadStatus('No valid network data generated', 'error');
                return;
            }
            
            const nodeNameCount = {};
            const formattedNodes = graphData.nodes.map(node => {
                const baseName = node.name;
                nodeNameCount[baseName] = (nodeNameCount[baseName] || 0) + 1;
                
                const uniqueVisId = nodeNameCount[baseName] > 1 ? 
                    `${node.id}-${nodeNameCount[baseName]}` : node.id;
                
                return {
                    id: uniqueVisId,
                    label: node.name,
                    originalName: node.name,
                    originalId: node.id,
                    color: getNodeColor(node),
                    size: 15 + (node.centrality * 30),
                    title: createBOMTooltip(node),
                    community: node.community,
                    centrality: node.centrality,
                    risk: node.risk,
                    severity: node.severity || 0,
                    likelihood: node.likelihood || 0,
                    eml: node.eml || 0,
                    borderWidth: 2,
                    font: {
                        size: 14,
                        color: '#2c3e50'
                    }
                };
            });
            
            const nameToVisId = {};
            formattedNodes.forEach(node => {
                if (!nameToVisId[node.originalName]) {
                    nameToVisId[node.originalName] = [];
                }
                nameToVisId[node.originalName].push(node.id);
            });
            
            const formattedEdges = [];
            let edgeIndex = 0;
            
            graphData.edges.forEach(edge => {
                const fromVisIds = nameToVisId[edge.from];
                const toVisIds = nameToVisId[edge.to];
                
                if (fromVisIds && toVisIds) {
                    formattedEdges.push({
                        id: edgeIndex++,
                        from: fromVisIds[0],
                        to: toVisIds[0],
                        dashes: edge.type === 'process',
                        color: { color: edge.type === 'process' ? '#888' : '#999' },
                        width: edge.type === 'process' ? 1 : 2
                    });
                }
            });
            
            originalData = { nodes: formattedNodes, edges: formattedEdges };
            
            const networkContainer = document.getElementById('network');
            networkContainer.innerHTML = '';
            
            if (network && typeof network.destroy === 'function') {
                network.destroy();
                network = null;
                nodes = null;
                edges = null;
            }
            
            initializeNetworkWithData(formattedNodes, formattedEdges);
            
            updateNetworkStats();
            createCommunityLegend();
            updateUploadStatus(`✓ Network built: ${formattedNodes.length} nodes, ${formattedEdges.length} edges (${processFlows.length} process flows)`, 'success');
            
            console.log('Network initialization complete');
        }
        
        function initializeNetworkWithData(nodeData, edgeData) {
            nodes = new vis.DataSet(nodeData);
            edges = new vis.DataSet(edgeData);
            
            const container = document.getElementById('network');
            const data = { nodes: nodes, edges: edges };
            
            const options = {
                physics: {
                    enabled: true,
                    stabilization: { iterations: 100 },
                    barnesHut: {
                        gravitationalConstant: -8000,
                        centralGravity: 0.3,
                        springLength: 95
                    }
                },
                interaction: {
                    hover: true,
                    selectConnectedEdges: true,
                    hoverConnectedEdges: true
                },
                nodes: {
                    shape: 'dot',
                    font: { 
                        size: 14, 
                        color: '#2c3e50',
                        strokeWidth: 1, 
                        strokeColor: '#ffffff'
                    }
                },
                edges: {
                    smooth: { type: 'continuous', roundness: 0.5 }
                }
            };
            
            network = new vis.Network(container, data, options);
            
            network.on('click', onNodeClick);
            network.on('hoverNode', onNodeHover);
            network.on('blurNode', onNodeBlur);
            network.on('doubleClick', onNodeDoubleClick);
        }
        
        function onNodeClick(params) {
            if (params.nodes.length > 0) {
                selectedNodeId = params.nodes[0];
                showNodeDetails(selectedNodeId);
                showNodePopup(selectedNodeId, params.pointer.DOM);
            }
        }
        
        function onNodeHover(params) {
            if (params.node) {
                network.canvas.body.container.style.cursor = 'pointer';
                showNodePopup(params.node, params.pointer.DOM);
            }
        }
        
        function onNodeBlur(params) {
            network.canvas.body.container.style.cursor = 'default';
            hideNodePopup();
        }
        
        function onNodeDoubleClick(params) {
            if (params.nodes.length > 0) {
                network.focus(params.nodes[0], {
                    scale: 1.5,
                    animation: { duration: 1000 }
                });
            }
        }
        
        // Convert severity to 1-10 scale
        function getSeverityScore(severity) {
            // Convert dollar amounts to 1-10 scale (log scale)
            const logSeverity = Math.log10(severity + 1);
            // Map 3-7 (roughly $1k to $10M) to 1-10 scale
            const score = Math.min(10, Math.max(1, Math.round((logSeverity - 3) * 2.5 + 1)));
            return score;
        }
        
        // Convert EML to 1-10 score (Expected Monetary Loss score)
        function getEMLScore(eml) {
            // Convert EML dollar amounts to 1-10 scale (log scale)
            const logEML = Math.log10(eml + 1);
            // Map 3-7 (roughly $1k to $10M) to 1-10 scale
            const score = Math.min(10, Math.max(1, Math.round((logEML - 3) * 2.5 + 1)));
            return score;
        }
        
        // Convert EML score to overall risk score (1-30 scale)
        function getOverallRiskScore(eml) {
            const emlScore = getEMLScore(eml);
            // Map 1-10 EML score to 1-30 risk score
            return Math.round(emlScore * 3);
        }

        function showNodePopup(nodeId, position) {
            const nodeData = originalData ? originalData.nodes.find(n => n.id === nodeId) : null;
            if (!nodeData) return;
            
            hideNodePopup();
            
            const severityScore = getSeverityScore(nodeData.severity);
            const emlScore = getEMLScore(nodeData.eml);
            const centralityScore = (nodeData.centrality * 100).toFixed(1);
            const overallRiskScore = getOverallRiskScore(nodeData.eml).toFixed(0);
            const riskLevel = getRiskLevel(nodeData.eml);
            
            const popup = document.createElement('div');
            popup.id = 'nodePopup';
            popup.style.cssText = `
                position: fixed;
                background: white;
                border: 2px solid #3498db;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 350px;
                font-family: 'Inter', sans-serif;
                line-height: 1.5;
                left: ${position.x + 20}px;
                top: ${position.y - 50}px;
                pointer-events: none;
            `;
            
            popup.innerHTML = `
                <div style="border-bottom: 2px solid #3498db; padding-bottom: 12px; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #1E242C; font-size: 1.1rem; font-weight: 600;">
                        ${nodeData.label}
                    </h4>
                </div>
                
                <div style="margin: 12px 0;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <strong style="color: #64748b; font-size: 0.9rem;">Community:</strong> 
                        <span style="background: ${palette[nodeData.community % palette.length]}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                            ${nodeData.community}
                        </span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #64748b; font-size: 0.9rem;">Centrality:</strong> 
                        <span style="color: #3498db; font-weight: 700; font-size: 1rem;">${centralityScore}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #64748b; font-size: 0.9rem;">Severity:</strong> 
                        <span style="color: #e67e22; font-weight: 700; font-size: 1rem;">${severityScore}/10</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #64748b; font-size: 0.9rem;">EML Score:</strong> 
                        <span style="color: #9b59b6; font-weight: 700; font-size: 1rem;">${emlScore}/10</span>
                    </div>
                </div>
                
                <div style="margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #64748b; font-size: 0.9rem;">Risk Analysis:</strong>
                        <span style="background: ${riskLevel === 'low' ? '#10b981' : riskLevel === 'medium' ? '#f39c12' : '#e74c3c'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase;">
                            ${riskLevel}
                        </span>
                    </div>
                    
                    <div style="background: #e5e7eb; height: 16px; border-radius: 8px; margin: 8px 0; overflow: hidden; position: relative;">
                        <div style="height: 100%; background: ${getRiskHeatmapColor(nodeData.eml)}; width: ${Math.min(100, (overallRiskScore / 30) * 100)}%; border-radius: 8px; transition: width 0.3s ease;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; font-weight: 600; color: white;">
                            ${overallRiskScore}/30
                        </div>
                    </div>
                </div>
                
                <div style="font-size: 0.8rem; color: #64748b;">
                    ${riskLevel === 'low' ? 'Low complexity component with minimal project impact.' :
                      riskLevel === 'medium' ? 'Moderate complexity with some system interdependencies.' :
                      'High complexity component requiring close monitoring.'}
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Smart positioning
            const rect = popup.getBoundingClientRect();
            if (rect.right > window.innerWidth - 20) {
                popup.style.left = (position.x - rect.width - 20) + 'px';
            }
            if (rect.bottom > window.innerHeight - 20) {
                popup.style.top = (position.y - rect.height + 20) + 'px';
            }
        }
        
        function hideNodePopup() {
            const existingPopup = document.getElementById('nodePopup');
            if (existingPopup) {
                existingPopup.remove();
            }
        }
        
        function showNodeDetails(nodeId) {
            const nodeData = originalData ? originalData.nodes.find(n => n.id === nodeId) : null;
            if (!nodeData) return;
            
            const riskLevel = getRiskLevel(nodeData.eml);
            const riskWidth = Math.min(100, Math.log10(nodeData.eml + 1) / 6 * 100);
            
            document.getElementById('nodeDetailsContent').innerHTML = `
                <div class="node-details">
                    <h4>${nodeData.label}</h4>
                    <div class="detail-row">
                        <span class="detail-label">Severity ($):</span>
                        <span class="detail-value">${nodeData.severity.toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Likelihood (/yr):</span>
                        <span class="detail-value">${nodeData.likelihood.toFixed(3)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">EML ($):</span>
                        <span class="detail-value" style="font-weight: 700;">${nodeData.eml.toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Community:</span>
                        <span class="detail-value">${nodeData.community}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Centrality:</span>
                        <span class="detail-value">${nodeData.centrality.toFixed(3)}</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <div class="detail-label">EML Risk Level:</div>
                        <div class="risk-meter">
                            <div class="risk-fill risk-${riskLevel}" style="width: ${riskWidth}%">
                                <div class="risk-text">${(nodeData.eml/1000).toFixed(0)}k</div>
                            </div>
                        </div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">
                            Risk Level: ${riskLevel.toUpperCase()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function setColorMode(mode) {
            colorMode = mode;
            
            const riskBtn = document.getElementById('riskModeBtn');
            const communityBtn = document.getElementById('communityModeBtn');
            
            if (mode === 'risk') {
                riskBtn.style.background = 'var(--success-color)';
                riskBtn.classList.remove('secondary');
                communityBtn.style.background = '';
                communityBtn.classList.add('secondary');
                
                createRiskLegend();
                document.getElementById('communitySection').style.display = 'none';
                
            } else {
                communityBtn.style.background = 'var(--success-color)';
                communityBtn.classList.remove('secondary');
                riskBtn.style.background = '';
                riskBtn.classList.add('secondary');
                
                document.getElementById('colorLegend').innerHTML = '';
                document.getElementById('communitySection').style.display = 'block';
            }
            
            if (originalData && originalData.nodes) {
                const updatedNodes = originalData.nodes.map(node => ({
                    ...node,
                    color: getNodeColor(node)
                }));
                
                if (nodes) {
                    nodes.update(updatedNodes);
                }
                
                if (mode === 'community') {
                    createCommunityLegend();
                }
            }
        }
        
        function createRiskLegend() {
            const riskRanges = [
                { min: 1, max: 3, color: '#10b981', label: 'Low EML Score 1-3' },
                { min: 4, max: 5, color: '#fbbf24', label: 'Medium EML Score 4-5' },
                { min: 6, max: 7, color: '#fb923c', label: 'High EML Score 6-7' },
                { min: 8, max: 10, color: '#ef4444', label: 'Critical EML Score 8-10' }
            ];
            
            const legendHTML = riskRanges.map(range => `
                <div class="legend-item" style="margin: 0.25rem 0;">
                    <div class="legend-color" style="background-color: ${range.color}; width: 20px; height: 12px; border-radius: 3px;"></div>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">${range.label}</div>
                </div>
            `).join('');
            
            document.getElementById('colorLegend').innerHTML = `
                <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">EML Risk Heat Map:</div>
                ${legendHTML}
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    EML Score = Severity × Likelihood (1-10 scale)
                </div>
            `;
        }
        
        function createCommunityLegend() {
            if (!originalData || !originalData.nodes) return;
            
            const communities = {};
            originalData.nodes.forEach(node => {
                if (!communities[node.community]) {
                    communities[node.community] = {
                        color: palette[node.community % palette.length],
                        count: 0,
                        totalEML: 0
                    };
                }
                communities[node.community].count++;
                communities[node.community].totalEML += node.eml;
            });
            
            const legendHTML = Object.entries(communities).map(([id, data]) => {
                const avgEML = data.totalEML / data.count;
                const riskLevel = getRiskLevel(avgEML);
                
                return `
                <div class="legend-item" onclick="highlightCommunity(${id})">
                    <div class="legend-color" style="background-color: ${data.color}"></div>
                    <div>
                        <div><strong>Community ${id}</strong> (${data.count} nodes)</div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">
                            Avg EML: ${(avgEML/1000).toFixed(0)}k (${riskLevel})
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            document.getElementById('communityLegend').innerHTML = legendHTML;
        }
        
        function highlightCommunity(communityId) {
            if (!originalData || !network) return;
            
            const updatedNodes = originalData.nodes.map(node => ({
                ...node,
                color: {
                    ...node.color,
                    background: node.community == communityId ? 
                        node.color.background : lightenColor(node.color.background, 0.7)
                },
                borderWidth: node.community == communityId ? 5 : 2
            }));
            
            nodes.update(updatedNodes);
        }
        
        function createBOMTooltip(node) {
            const riskLevel = getRiskLevel(node.risk);
            return `<div style="padding: 10px; max-width: 200px;">
                <h4 style="margin: 0 0 10px 0; color: #1E242C;">${node.name}</h4>
                <p><strong>Severity:</strong> ${node.severity.toLocaleString()}</p>
                <p><strong>Likelihood:</strong> ${node.likelihood.toFixed(3)}/yr</p>
                <p><strong>EML:</strong> ${node.eml.toLocaleString()}</p>
                <p><strong>Community:</strong> ${node.community || 0}</p>
                <p><strong>Risk Level:</strong> ${riskLevel}</p>
            </div>`;
        }
        
        function updateUploadStatus(message, type) {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = message;
            statusElement.style.color = type === 'error' ? '#dc2626' : 
                                      type === 'success' ? '#059669' : '#64748b';
        }
        
        function updateNetworkStats() {
            if (originalData) {
                document.getElementById('nodeCount').textContent = originalData.nodes.length;
                document.getElementById('edgeCount').textContent = originalData.edges.length;
                
                const communities = new Set(originalData.nodes.map(n => n.community));
                document.getElementById('communityCount').textContent = communities.size;
                document.getElementById('modularityQ').textContent = '0.67';
            }
        }
        
        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            if (network) {
                network.setOptions({ physics: { enabled: physicsEnabled } });
            }
        }
        
        function fitToView() {
            if (network) {
                network.fit({
                    animation: { duration: 1000 }
                });
            }
        }
        
        function resetView() {
            if (originalData && network) {
                nodes.update(originalData.nodes);
                edges.update(originalData.edges);
                fitToView();
            }
        }
        
        function searchNodes() {
            const searchTerm = document.getElementById('nodeSearch').value.toLowerCase();
            
            if (searchTerm === '' || !originalData) {
                resetView();
                return;
            }
            
            const matchingNodes = originalData.nodes.filter(node => 
                node.label.toLowerCase().includes(searchTerm)
            );
            
            if (matchingNodes.length === 0) return;
            
            const matchingIds = matchingNodes.map(n => n.id);
            
            const updatedNodes = originalData.nodes.map(node => ({
                ...node,
                color: {
                    ...node.color,
                    background: matchingIds.includes(node.id) ? '#f39c12' : lightenColor(node.color.background, 0.8)
                },
                borderWidth: matchingIds.includes(node.id) ? 5 : 1
            }));
            
            nodes.update(updatedNodes);
            
            if (matchingNodes.length > 0) {
                network.focus(matchingNodes[0].id, {
                    scale: 1.2,
                    animation: { duration: 1000 }
                });
            }
        }
        
        function togglePanel() {
            const panel = document.getElementById('controlsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
