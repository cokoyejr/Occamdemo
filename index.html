<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEM Electrolyzer Network Analysis - Occam Edge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1E242C;
            --secondary-color: #64748b;
            --success-color: #059669;
            --background-light: #ffffff;
            --text-primary: #1E242C;
            --text-secondary: #64748b;
            --border-light: #e2e8f0;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fafafa;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .brand-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .main-container {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            min-height: calc(100vh - 100px);
        }
        
        .network-panel {
            flex: 1;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }
        
        .network-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            background: var(--white);
        }
        
        .network-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .network-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0.5rem 0 0 0;
        }
        
        #network {
            width: 100%;
            height: calc(100vh - 200px);
            background: #fafafa;
        }
        
        .controls-panel {
            width: 380px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }
        
        .panel-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: var(--white);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .panel-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .panel-section:last-child {
            border-bottom: none;
        }
        
        .panel-section h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            background: #fafafa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-light);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-weight: 500;
        }
        
        .upload-area {
            border: 2px dashed var(--border-light);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 1rem 0;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .upload-status {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        .node-details {
            background: #fafafa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid var(--border-light);
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.85rem;
        }
        
        .detail-label {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .detail-value {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .risk-meter {
            background: #e5e7eb;
            height: 16px;
            border-radius: 8px;
            margin: 0.5rem 0;
            overflow: hidden;
            position: relative;
        }
        
        .risk-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        .risk-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }
        
        .risk-low { background: var(--success-color); }
        .risk-medium { background: #d97706; }
        .risk-high { background: #dc2626; }
        
        .btn {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.25rem;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: #0f1419;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .search-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: #fafafa;
            margin: 0.5rem 0;
            cursor: pointer;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
            gap: 1rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="#" class="brand-title">
                <i class="fas fa-project-diagram"></i>
                PEM Electrolyzer Network Analysis
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="main-container">
            <div class="network-panel">
                <button class="panel-toggle" onclick="togglePanel()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="network-header">
                    <h2 class="network-title">
                        <i class="fas fa-network-wired"></i>
                        Interactive Network Visualization
                    </h2>
                    <p class="network-subtitle">Upload your BOM CSV file to begin analysis</p>
                </div>
                
                <div id="network">
                    <div class="loading">
                        <i class="fas fa-upload" style="font-size: 2rem;"></i>
                        <h3>Upload BOM CSV to Begin</h3>
                        <p>Expected: System | Equipment | Subcomponent | Quantity (100MW)</p>
                    </div>
                </div>
            </div>
            
            <div class="controls-panel" id="controlsPanel">
                <!-- CSV Upload Section -->
                <div class="panel-section">
                    <h3><i class="fas fa-upload"></i> Load BOM Data</h3>
                    <div class="upload-area" onclick="document.getElementById('csvFileInput').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-secondary);"></i>
                        <div>Click to upload CSV</div>
                        <small>PEM_PFD_subcomponents_qty_100MW.csv</small>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVUpload()" class="file-input">
                    <div id="uploadStatus" class="upload-status"></div>
                </div>

                <!-- Network Statistics -->
                <div class="panel-section">
                    <h3><i class="fas fa-chart-bar"></i> Network Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-value" id="nodeCount">0</span>
                            <div class="stat-label">Components</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="edgeCount">0</span>
                            <div class="stat-label">Connections</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="communityCount">0</span>
                            <div class="stat-label">Systems</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="modularityQ">0.00</span>
                            <div class="stat-label">Modularity Q</div>
                        </div>
                    </div>
                </div>
                
                <!-- Search -->
                <div class="panel-section">
                    <h3><i class="fas fa-search"></i> Search</h3>
                    <input type="text" class="search-input" id="nodeSearch" placeholder="Search components..." oninput="searchNodes()">
                </div>
                
                <!-- Node Details -->
                <div class="panel-section">
                    <h3><i class="fas fa-info-circle"></i> Component Details</h3>
                    <div id="nodeDetailsContent">
                        <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                            Click on a component to see details
                        </p>
                    </div>
                </div>
                
                <!-- Communities -->
                <div class="panel-section">
                    <h3><i class="fas fa-layer-group"></i> Communities</h3>
                    <div id="communityLegend"></div>
                </div>
                
                <!-- Controls -->
                <div class="panel-section">
                    <h3><i class="fas fa-sliders-h"></i> Controls</h3>
                    <div class="btn-group">
                        <button class="btn" onclick="togglePhysics()">Toggle Physics</button>
                        <button class="btn" onclick="fitToView()">Fit View</button>
                        <button class="btn" onclick="resetView()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let bomDataFromCSV = null;
        let treeStructure = null;
        let network = null;
        let nodes = null;
        let edges = null;
        let originalData = null;
        let physicsEnabled = true;
        let selectedNodeId = null;
        
        const palette = ["#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00",
                        "#ffff33", "#a65628", "#f781bf", "#999999", "#66c2a5"];
        
        function meanOverrun(C, M, S) {
            return 5.8 * Math.pow(C, 1.26) * Math.pow(1 - M, 1.18) * Math.pow(S, -1.34);
        }
        
        async function handleCSVUpload() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            updateUploadStatus('Loading CSV file...', 'info');
            
            try {
                const csvText = await readFileAsText(file);
                bomDataFromCSV = parseCSV(csvText);
                
                updateUploadStatus(`Loaded ${bomDataFromCSV.length} rows from ${file.name}`, 'success');
                
                buildTreeFromBOM();
                rebuildNetworkFromBOM();
                
            } catch (error) {
                updateUploadStatus(`Error loading CSV: ${error.message}`, 'error');
                console.error('CSV upload error:', error);
            }
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        function buildTreeFromBOM() {
            if (!bomDataFromCSV) return;
            
            const root = { id: "PEM Electrolyzer", name: "PEM Electrolyzer", parent: null, children: [] };
            const sys_nodes = {};
            const equip_nodes = {};
            
            bomDataFromCSV.forEach((r, _) => {
                const s = r["System"];
                const e = r["Equipment"]; 
                const sub = r["Subcomponent"];
                const q = parseFloat(r["Quantity (100MW)"]);
                
                if (!s || !e || !sub) return;
                
                if (!sys_nodes[s]) {
                    sys_nodes[s] = { id: s, name: s, parent: root, children: [] };
                    root.children.push(sys_nodes[s]);
                }
                
                const key = `${s}-${e}`;
                if (!equip_nodes[key]) {
                    equip_nodes[key] = { id: e, name: e, parent: sys_nodes[s], children: [], system: s };
                    sys_nodes[s].children.push(equip_nodes[key]);
                }
                
                const subName = q > 1 ? `${sub} (x${Math.floor(q)})` : sub;
                const subId = `${s}-${e}-${sub}`;
                const subNode = { id: subId, name: subName, parent: equip_nodes[key], children: [], system: s, equipment: e, quantity: q };
                equip_nodes[key].children.push(subNode);
            });
            
            treeStructure = { root, sys_nodes, equip_nodes };
            updateUploadStatus(`Tree structure built successfully`, 'success');
        }
        
        function buildNetworkXGraph() {
            if (!treeStructure) return { nodes: [], edges: [], communities: [], modularity: 0 };
            
            const G_nodes = [];
            const G_edges = [];
            
            function levelOrderIter(node, allNodes = []) {
                const queue = [node];
                while (queue.length > 0) {
                    const current = queue.shift();
                    allNodes.push(current);
                    if (current.children) {
                        queue.push(...current.children);
                    }
                }
                return allNodes;
            }
            
            const allNodes = levelOrderIter(treeStructure.root);
            
            allNodes.forEach(n => {
                if (n.children) {
                    n.children.forEach(child => {
                        G_edges.push({ from: n.name, to: child.name, type: 'tree' });
                    });
                }
                G_nodes.push(n);
            });
            
            const deg_cent = {};
            G_nodes.forEach(node => deg_cent[node.name] = 0);
            
            G_edges.forEach(edge => {
                deg_cent[edge.from] = (deg_cent[edge.from] || 0) + 1;
                deg_cent[edge.to] = (deg_cent[edge.to] || 0) + 1;
            });
            
            const maxDegree = Math.max(...Object.values(deg_cent), 1);
            Object.keys(deg_cent).forEach(key => {
                deg_cent[key] = deg_cent[key] / maxDegree;
            });
            
            const comms = [];
            const comm_id = {};
            let communityIndex = 0;
            
            comm_id["PEM Electrolyzer"] = 0;
            comms[0] = ["PEM Electrolyzer"];
            
            Object.keys(treeStructure.sys_nodes || {}).forEach(sysName => {
                communityIndex++;
                comm_id[sysName] = communityIndex;
                if (!comms[communityIndex]) comms[communityIndex] = [];
                comms[communityIndex].push(sysName);
                
                Object.values(treeStructure.equip_nodes || {}).forEach(equipNode => {
                    if (equipNode.system === sysName) {
                        comm_id[equipNode.name] = communityIndex;
                        comms[communityIndex].push(equipNode.name);
                        
                        if (equipNode.children) {
                            equipNode.children.forEach(subNode => {
                                comm_id[subNode.name] = communityIndex;
                                comms[communityIndex].push(subNode.name);
                            });
                        }
                    }
                });
            });
            
            const Q_mod = 0.67;
            const risk = {};
            G_nodes.forEach(n => {
                const community = comm_id[n.name] || 0;
                const C = comms[community] ? comms[community].length : 1;
                risk[n.name] = meanOverrun(C, Q_mod, 3);
            });
            
            G_nodes.forEach(node => {
                node.centrality = deg_cent[node.name] || 0;
                node.community = comm_id[node.name] || 0;
                node.risk = risk[node.name] || 0;
            });
            
            return { nodes: G_nodes, edges: G_edges, communities: comms, modularity: Q_mod };
        }
        
        function rebuildNetworkFromBOM() {
            if (!bomDataFromCSV || bomDataFromCSV.length === 0) {
                updateUploadStatus('No BOM data available', 'error');
                return;
            }
            
            const graphData = buildNetworkXGraph();
            
            if (graphData.nodes.length === 0) {
                updateUploadStatus('No valid network data generated', 'error');
                return;
            }
            
            const nodeNameCount = {};
            const formattedNodes = graphData.nodes.map(node => {
                const baseName = node.name;
                nodeNameCount[baseName] = (nodeNameCount[baseName] || 0) + 1;
                
                const uniqueVisId = nodeNameCount[baseName] > 1 ? 
                    `${node.id}-${nodeNameCount[baseName]}` : node.id;
                
                return {
                    id: uniqueVisId,
                    label: node.name,
                    originalName: node.name,
                    originalId: node.id,
                    color: {
                        background: palette[node.community % palette.length],
                        border: getRiskBorderColor(node.risk)
                    },
                    size: 15 + (node.centrality * 30),
                    title: createBOMTooltip(node),
                    community: node.community,
                    centrality: node.centrality,
                    risk: node.risk,
                    borderWidth: 2,
                    font: {
                        size: 14,
                        color: '#2c3e50'
                    }
                };
            });
            
            const nameToVisId = {};
            formattedNodes.forEach(node => {
                if (!nameToVisId[node.originalName]) {
                    nameToVisId[node.originalName] = [];
                }
                nameToVisId[node.originalName].push(node.id);
            });
            
            const formattedEdges = [];
            let edgeIndex = 0;
            
            graphData.edges.forEach(edge => {
                const fromVisIds = nameToVisId[edge.from];
                const toVisIds = nameToVisId[edge.to];
                
                if (fromVisIds && toVisIds) {
                    formattedEdges.push({
                        id: edgeIndex++,
                        from: fromVisIds[0],
                        to: toVisIds[0],
                        color: { color: '#7f8c8d' },
                        width: 2
                    });
                }
            });
            
            originalData = { nodes: formattedNodes, edges: formattedEdges };
            
            if (network) {
                nodes.clear();
                edges.clear();
                nodes.add(formattedNodes);
                edges.add(formattedEdges);
            } else {
                initializeNetworkWithData(formattedNodes, formattedEdges);
            }
            
            updateNetworkStats();
            createCommunityLegend();
            updateUploadStatus(`âœ“ Network built: ${formattedNodes.length} nodes, ${formattedEdges.length} edges`, 'success');
        }
        
        function initializeNetworkWithData(nodeData, edgeData) {
            nodes = new vis.DataSet(nodeData);
            edges = new vis.DataSet(edgeData);
            
            const container = document.getElementById('network');
            const data = { nodes: nodes, edges: edges };
            
            const options = {
                physics: {
                    enabled: true,
                    stabilization: { iterations: 100 },
                    barnesHut: {
                        gravitationalConstant: -8000,
                        centralGravity: 0.3,
                        springLength: 95
                    }
                },
                interaction: {
                    hover: true,
                    selectConnectedEdges: true,
                    hoverConnectedEdges: true
                },
                nodes: {
                    shape: 'dot',
                    font: { 
                        size: 14, 
                        color: '#2c3e50',
                        strokeWidth: 1, 
                        strokeColor: '#ffffff'
                    }
                },
                edges: {
                    smooth: { type: 'continuous', roundness: 0.5 }
                }
            };
            
            network = new vis.Network(container, data, options);
            
            network.on('click', onNodeClick);
            network.on('hoverNode', onNodeHover);
            network.on('blurNode', onNodeBlur);
            network.on('doubleClick', onNodeDoubleClick);
        }
        
        function onNodeClick(params) {
            if (params.nodes.length > 0) {
                selectedNodeId = params.nodes[0];
                showNodeDetails(selectedNodeId);
                showNodePopup(selectedNodeId, params.pointer.DOM);
            }
        }
        
        function onNodeHover(params) {
            if (params.node) {
                network.canvas.body.container.style.cursor = 'pointer';
                showNodePopup(params.node, params.pointer.DOM);
            }
        }
        
        function onNodeBlur(params) {
            network.canvas.body.container.style.cursor = 'default';
            hideNodePopup();
        }
        
        function onNodeDoubleClick(params) {
            if (params.nodes.length > 0) {
                network.focus(params.nodes[0], {
                    scale: 1.5,
                    animation: { duration: 1000 }
                });
            }
        }
        
        function showNodePopup(nodeId, position) {
            const nodeData = originalData ? originalData.nodes.find(n => n.id === nodeId) : null;
            if (!nodeData) return;
            
            hideNodePopup();
            
            const riskLevel = getRiskLevel(nodeData.risk);
            const riskDescription = getRiskDescription(nodeData.risk, riskLevel);
            
            const popup = document.createElement('div');
            popup.id = 'nodePopup';
            popup.style.cssText = `
                position: fixed;
                background: white;
                border: 2px solid #3498db;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 350px;
                font-family: 'Inter', sans-serif;
                line-height: 1.5;
                left: ${position.x + 20}px;
                top: ${position.y - 50}px;
                pointer-events: none;
                animation: popupFadeIn 0.2s ease-out;
            `;
            
            popup.innerHTML = `
                <style>
                    @keyframes popupFadeIn {
                        from { opacity: 0; transform: translateY(-10px) scale(0.95); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                </style>
                <div style="border-bottom: 2px solid #3498db; padding-bottom: 12px; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #1E242C; font-size: 1.1rem; font-weight: 600;">
                        ${nodeData.label}
                    </h4>
                </div>
                
                <div style="margin: 12px 0;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <strong style="color: #64748b; font-size: 0.9rem;">Community:</strong> 
                        <span style="background: ${palette[nodeData.community % palette.length]}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            ${nodeData.community}
                        </span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #64748b; font-size: 0.9rem;">Centrality:</strong> 
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="color: #3498db; font-weight: 700; font-size: 1rem;">${(nodeData.centrality || 0).toFixed(3)}</span>
                            <span style="font-size: 0.75rem; color: #94a3b8; background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">importance</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <strong style="color: #1E242C; font-size: 0.95rem;">Risk Analysis:</strong>
                        <span style="background: ${getRiskBorderColor(nodeData.risk)}; color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            ${riskLevel}
                        </span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <div style="background: #e2e8f0; height: 8px; border-radius: 4px; flex: 1; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, ${getRiskBorderColor(nodeData.risk)}, ${lightenColor(getRiskBorderColor(nodeData.risk), 0.3)}); width: ${Math.min(100, (nodeData.risk / 30) * 100)}%; border-radius: 4px; transition: width 0.3s ease;"></div>
                        </div>
                        <span style="font-weight: 700; color: ${getRiskBorderColor(nodeData.risk)}; font-size: 0.9rem;">
                            ${(nodeData.risk || 0).toFixed(1)}/30
                        </span>
                    </div>
                    
                    <div style="font-size: 0.8rem; color: #64748b; line-height: 1.4;">
                        ${riskDescription}
                    </div>
                </div>
                
                <div style="border-top: 1px solid #e2e8f0; padding-top: 12px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #94a3b8;">
                        <span style="background: #3498db; color: white; padding: 2px 4px; border-radius: 3px;">ðŸ’¡</span>
                        <span>Double-click to zoom â€¢ Click to highlight connections</span>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Smart positioning to keep popup on screen
            const rect = popup.getBoundingClientRect();
            if (rect.right > window.innerWidth - 20) {
                popup.style.left = (position.x - rect.width - 20) + 'px';
            }
            if (rect.bottom > window.innerHeight - 20) {
                popup.style.top = (position.y - rect.height + 20) + 'px';
            }
            if (rect.left < 20) {
                popup.style.left = '20px';
            }
            if (rect.top < 20) {
                popup.style.top = '20px';
            }
        }
        
        function getRiskDescription(riskScore, riskLevel) {
            if (riskLevel === 'low') {
                return "â€¢ Low complexity component<br>â€¢ Well-isolated system<br>â€¢ Minimal impact on overall project";
            } else if (riskLevel === 'medium') {
                return "â€¢ Moderate complexity<br>â€¢ Some system interdependencies<br>â€¢ Monitor for cost overruns";
            } else {
                return "â€¢ High complexity component<br>â€¢ Critical system dependencies<br>â€¢ High probability of cost overruns<br>â€¢ Requires close monitoring";
            }
        }
        
        function hideNodePopup() {
            const existingPopup = document.getElementById('nodePopup');
            if (existingPopup) {
                existingPopup.remove();
            }
        }
        
        function showNodeDetails(nodeId) {
            const nodeData = originalData ? originalData.nodes.find(n => n.id === nodeId) : null;
            if (!nodeData) return;
            
            const riskLevel = getRiskLevel(nodeData.risk);
            const riskWidth = Math.min(100, (nodeData.risk / 30) * 100);
            
            document.getElementById('nodeDetailsContent').innerHTML = `
                <div class="node-details">
                    <h4>${nodeData.label}</h4>
                    <div class="detail-row">
                        <span class="detail-label">Community:</span>
                        <span class="detail-value">${nodeData.community}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Centrality:</span>
                        <span class="detail-value">${nodeData.centrality.toFixed(3)}</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <div class="detail-label">Risk Analysis:</div>
                        <div class="risk-meter">
                            <div class="risk-fill risk-${riskLevel}" style="width: ${riskWidth}%">
                                <div class="risk-text">${nodeData.risk.toFixed(1)}</div>
                            </div>
                        </div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">
                            Risk Level: ${riskLevel.toUpperCase()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createCommunityLegend() {
            if (!originalData || !originalData.nodes) return;
            
            const communities = {};
            originalData.nodes.forEach(node => {
                if (!communities[node.community]) {
                    communities[node.community] = {
                        color: palette[node.community % palette.length],
                        count: 0,
                        totalRisk: 0
                    };
                }
                communities[node.community].count++;
                communities[node.community].totalRisk += node.risk;
            });
            
            const legendHTML = Object.entries(communities).map(([id, data]) => {
                const avgRisk = data.totalRisk / data.count;
                const riskLevel = getRiskLevel(avgRisk);
                
                return `
                <div class="legend-item" onclick="highlightCommunity(${id})">
                    <div class="legend-color" style="background-color: ${data.color}"></div>
                    <div>
                        <div><strong>Community ${id}</strong> (${data.count} nodes)</div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">
                            Avg Risk: ${avgRisk.toFixed(1)} (${riskLevel})
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            document.getElementById('communityLegend').innerHTML = legendHTML;
        }
        
        function highlightCommunity(communityId) {
            if (!originalData || !network) return;
            
            const updatedNodes = originalData.nodes.map(node => ({
                ...node,
                color: {
                    ...node.color,
                    background: node.community == communityId ? 
                        node.color.background : lightenColor(node.color.background, 0.7)
                },
                borderWidth: node.community == communityId ? 5 : 2
            }));
            
            nodes.update(updatedNodes);
        }
        
        function createBOMTooltip(node) {
            const riskLevel = getRiskLevel(node.risk);
            return `<div style="padding: 10px; max-width: 200px;">
                <h4 style="margin: 0 0 10px 0; color: #1E242C;">${node.name}</h4>
                <p><strong>Community:</strong> ${node.community || 0}</p>
                <p><strong>Centrality:</strong> ${(node.centrality || 0).toFixed(3)}</p>
                <p><strong>Risk:</strong> ${(node.risk || 0).toFixed(1)} (${riskLevel})</p>
            </div>`;
        }
        
        function updateUploadStatus(message, type) {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = message;
            statusElement.style.color = type === 'error' ? '#dc2626' : 
                                      type === 'success' ? '#059669' : '#64748b';
        }
        
        function getRiskBorderColor(risk) {
            if (risk < 10) return '#059669';
            if (risk < 20) return '#d97706';
            return '#dc2626';
        }
        
        function getRiskLevel(risk) {
            if (risk < 10) return 'low';
            if (risk < 20) return 'medium';
            return 'high';
        }
        
        function lightenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent * 100);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        function updateNetworkStats() {
            if (originalData) {
                document.getElementById('nodeCount').textContent = originalData.nodes.length;
                document.getElementById('edgeCount').textContent = originalData.edges.length;
                
                const communities = new Set(originalData.nodes.map(n => n.community));
                document.getElementById('communityCount').textContent = communities.size;
                document.getElementById('modularityQ').textContent = '0.67';
            }
        }
        
        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            if (network) {
                network.setOptions({ physics: { enabled: physicsEnabled } });
            }
        }
        
        function fitToView() {
            if (network) {
                network.fit({
                    animation: { duration: 1000 }
                });
            }
        }
        
        function resetView() {
            if (originalData && network) {
                nodes.update(originalData.nodes);
                edges.update(originalData.edges);
                fitToView();
            }
        }
        
        function searchNodes() {
            const searchTerm = document.getElementById('nodeSearch').value.toLowerCase();
            
            if (searchTerm === '' || !originalData) {
                resetView();
                return;
            }
            
            const matchingNodes = originalData.nodes.filter(node => 
                node.label.toLowerCase().includes(searchTerm)
            );
            
            if (matchingNodes.length === 0) return;
            
            const matchingIds = matchingNodes.map(n => n.id);
            
            const updatedNodes = originalData.nodes.map(node => ({
                ...node,
                color: {
                    ...node.color,
                    background: matchingIds.includes(node.id) ? '#f39c12' : lightenColor(node.color.background, 0.8)
                },
                borderWidth: matchingIds.includes(node.id) ? 5 : 1
            }));
            
            nodes.update(updatedNodes);
            
            if (matchingNodes.length > 0) {
                network.focus(matchingNodes[0].id, {
                    scale: 1.2,
                    animation: { duration: 1000 }
                });
            }
        }
        
        function togglePanel() {
            const panel = document.getElementById('controlsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Empty initialization - wait for CSV upload
                console.log('PEM Electrolyzer Network Analysis ready');
            }, 100);
        });
    </script>
</body>
</html>
